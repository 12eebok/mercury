/*!
The Markdown region utilizes the Markdown syntax (http://en.wikipedia.org/wiki/Markdown) to generate an html preview.
When saved this region will return the markdown content (unprocessed). This content can be used by your server to render
html content to a user, or to serve the markdown when editing.

Dependencies:
  showdown-1.0 - https://github.com/coreyti/showdown

This is still experimental and could be changed later to provide a way to fetch the markdown content for a given region
via Ajax.
*/
(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.MarkdownRegion=function(e){function n(e,t){this.el=e,this.options=t!=null?t:{};try{this.converter=this.options.converter||(new Showdown.converter).makeHtml}catch(r){return this.notify(this.t("requires Showdown"))}n.__super__.constructor.apply(this,arguments)}return t(n,e),n.define("Mercury.MarkdownRegion","markdown"),n.include(Mercury.Region.Modules.DropIndicator),n.include(Mercury.Region.Modules.TextSelection),n.include(Mercury.Region.Modules.FocusableTextarea),n.supported=!0,n.prototype.editableDragOver=!0,n.prototype.wrappers={h1:["# "," #"],h2:["## "," ##"],h3:["### "," ###"],h4:["#### "," ####"],h5:["##### "," #####"],h6:["###### "," ######"],pre:["```\n","\n```"],paragraph:["\n","\n"],blockquote:["> ",""],bold:["**"],italic:["_"],underline:["<u>","</u>"],sup:["<sup>","</sup>"],sub:["<sub>","</sub>"],unorderedList:["- ",""],orderedList:["1. ","",/^\d+. |$/gi],link:["[","](%s)",/^\[|\]\([^)]\)/gi],image:["![","](%s)",/^!\[|\]\([^)]\)/gi],style:['<span style="%s">',"</span>",/^(<span style="[^"]*">)|(<\/span>)$/gi],"class":['<span class="%s">',"</span>",/^(<span class="[^"]*">)|(<\/span>)$/gi]},n.prototype.blocks=["h1","h2","h3","h4","h5","h6","blockquote","unorderedList","orderedList"],n.prototype.value=function(e){var t;e==null&&(e=null);if(e===null||typeof e=="undefined")return this.focusable.val();this.focusable.val((t=e.val)!=null?t:e);if(e.sel)return this.setSelection(e.sel)},n.prototype.convertedValue=function(){return this.converter(this.value())},n.prototype.valueForStack=function(){return{sel:this.getSelection(),val:this.value()}},n.prototype.pushHistory=function(e){var t,r,i=this;e==null&&(e=null),e&&(t=[13,46,8].indexOf(e));if(e===null||t>=0&&t!==this.lastKeyCode)r=!0;return this.lastKeyCode=t,clearTimeout(this.historyTimeout),r?n.__super__.pushHistory.apply(this,arguments):this.historyTimeout=this.delay(2500,function(){return n.__super__.pushHistory.apply(i,arguments)})},n.prototype.onDropFile=function(e,t){var n,r=this;return n=new Mercury.Uploader(e,{mimeTypes:this.config("regions:markdown:mimeTypes")}),n.on("uploaded",function(e){return r.focus(),r.handleAction("file",e)})},n.prototype.onReturnKey=function(e){var t,n,r,i;t=this.expandSelectionToLines(this.getSelection()),i=t.text;if(i.match(/^- /))return e.preventDefault(),i.match(/^- ./)?this.replaceSelection("\n- "):this.replaceSelectedLine(t);if(n=i.match(/^(\d+)\. /))return e.preventDefault(),r=parseInt(n[1],10)+1,i.match(/^\d+\. ./)?this.replaceSelection("\n"+r+". "):this.replaceSelectedLine(t);if(n=i.match(/^(> )+/g))return e.preventDefault(),i.match(/^(> )+./g)?this.replaceSelection("\n"+n[0]):this.replaceSelectedLine(t)},n.prototype.actions={bold:function(){return this.toggleWrapSelectedWords("bold")},italic:function(){return this.toggleWrapSelectedWords("italic")},underline:function(){return this.toggleWrapSelectedWords("underline")},subscript:function(){return this.toggleWrapSelectedWords("sub")},superscript:function(){return this.toggleWrapSelectedWords("sup")},rule:function(){return this.replaceSelectionWithParagraph("- - -")},indent:function(){return this.wrapSelectedParagraphs("blockquote")},outdent:function(){return this.unwrapSelectedParagraphs("blockquote")},style:function(e){var t;return t=e.indexOf(":")>-1?"style":"class",t==="style"?this.unwrapSelectedWords("class"):this.unwrapSelectedWords("style"),this.toggleWrapSelectedWords(this.processWrapper(t,[e]))},html:function(e){return this.replaceSelection(e=(e.get&&e.get(0)||e).outerHTML||e)},block:function(e){var t,n,r,i;if(e==="blockquote"){this.unwrapSelectedParagraphs("orderedList"),this.unwrapSelectedParagraphs("unorderedList"),this.unwrapSelectedParagraphs("blockquote")||this.handleAction("indent");return}if(e==="pre"||e==="paragraph"){this.unwrapSelectedParagraphs("pre",{all:!0});if(this.wrappers[e])return this.wrapSelectedParagraphs(e,{all:!0})}i=this.blocks;for(n=0,r=i.length;n<r;n++)t=i[n],this.unwrapSelectedLines(t);if(this.wrappers[e])return this.wrapSelectedLines(e)},orderedList:function(){this.unwrapSelectedParagraphs("blockquote"),this.unwrapSelectedParagraphs("unorderedList");if(!this.unwrapSelectedParagraphs("orderedList"))return this.wrapSelectedParagraphs("orderedList")},unorderedList:function(){this.unwrapSelectedParagraphs("blockquote"),this.unwrapSelectedParagraphs("orderedList");if(!this.unwrapSelectedParagraphs("unorderedList"))return this.wrapSelectedParagraphs("unorderedList")},snippet:function(e){return console.error("not implemented")},file:function(e){var t;return t=e.isImage()?"image":"link",this.handleAction(t,e.get("url"),e.get("name"))},link:function(e,t){return this.wrapSelected(this.processWrapper("link",[e,t]),{text:t})},image:function(e,t){return this.wrapSelected(this.processWrapper("image",[e,t]),{text:t})}},n}(Mercury.Region)}).call(this);