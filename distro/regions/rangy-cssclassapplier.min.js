/**
 * CSS Class Applier module for Rangy.
 * Adds, removes and toggles CSS classes on Ranges and Selections
 *
 * Part of Rangy, a cross-browser JavaScript range and selection library
 * http://code.google.com/p/rangy/
 *
 * Depends on Rangy core.
 *
 * Copyright 2013, Tim Down
 * Licensed under the MIT license.
 * Version: 1.3alpha.755
 * Build date: 29 January 2013
 */
rangy.createModule("CssClassApplier",function(e,t){function n(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function s(e,t){return e.className&&new RegExp("(?:^|\\s)"+t+"(?:\\s|$)").test(e.className)}function i(e,t){e.className?s(e,t)||(e.className+=" "+t):e.className=t}function r(e){return e.split(/\s+/).sort().join(" ")}function o(e){return r(e.className)}function a(e,t){return o(e)==o(t)}function l(e,t,n,s,i){var r=e.node,o=e.offset,a=r,l=o;r==s&&o>i&&l++,r!=t||o!=n&&o!=n+1||(a=s,l+=i-n),r==t&&o>n+1&&l--,e.node=a,e.offset=l}function d(e,t,n,s){-1==n&&(n=t.childNodes.length);for(var i,r=e.parentNode,o=W.getNodeIndex(e),a=0;i=s[a++];)l(i,r,o,t,n);t.childNodes.length==n?t.appendChild(e):t.insertBefore(e,t.childNodes[n])}function p(e,t,n,s,i){for(var r,o=[];r=e.firstChild;)d(r,t,n++,i),o.push(r);return s&&e.parentNode.removeChild(e),o}function h(e,t){return p(e,e.parentNode,W.getNodeIndex(e),!0,t)}function u(e,t){var n=e.cloneRange();n.selectNodeContents(t);var s=n.intersection(e),i=s?s.toString():"";return n.detach(),""!=i}function f(e){for(var t,n=e.getNodes([3]),s=0;(t=n[s])&&!u(e,t);)++s;for(var i=n.length-1;(t=n[i])&&!u(e,t);)--i;return n.slice(s,i+1)}function c(e,t){if(e.attributes.length!=t.attributes.length)return!1;for(var n,s,i,r=0,o=e.attributes.length;o>r;++r)if(n=e.attributes[r],i=n.name,"class"!=i){if(s=t.attributes.getNamedItem(i),n.specified!=s.specified)return!1;if(n.specified&&n.nodeValue!==s.nodeValue)return!1}return!0}function g(e,t){for(var n,s=0,i=e.attributes.length;i>s;++s)if(n=e.attributes[s].name,(!t||!W.arrayContains(t,n))&&e.attributes[s].specified&&"class"!=n)return!0;return!1}function m(e,t){var n;for(var s in t)if(t.hasOwnProperty(s))if(n=t[s],"object"==typeof n){if(!m(e[s],n))return!1}else if(e[s]!==n)return!1;return!0}function N(e){var t;return e&&1==e.nodeType&&((t=e.parentNode)&&9==t.nodeType&&"on"==t.designMode||O(e)&&!O(e.parentNode))}function v(e){return(O(e)||1!=e.nodeType&&O(e.parentNode))&&!N(e)}function y(e){return e&&1==e.nodeType&&!B.test(j(e,"display"))}function C(e){if(0==e.data.length)return!0;if(z.test(e.data))return!1;var t=j(e.parentNode,"whiteSpace");switch(t){case"pre":case"pre-wrap":case"-moz-pre-wrap":return!1;case"pre-line":if(/[\r\n]/.test(e.data))return!1}return y(e.previousSibling)||y(e.nextSibling)}function T(e){var t,n,s=[];for(t=0;n=e[t++];)s.push(new M(n.startContainer,n.startOffset),new M(n.endContainer,n.endOffset));return s}function E(e,t){for(var n,s,i,r=0,o=e.length;o>r;++r)n=e[r],s=t[2*r],i=t[2*r+1],n.setStartAndEnd(s.node,s.offset,i.node,i.offset)}function b(e,t){return W.isCharacterDataNode(e)?0==t?!!e.previousSibling:t==e.length?!!e.nextSibling:!0:t>0&&t<e.childNodes.length}function S(e,n,s,i){var r,o,a=0==s;if(W.isAncestorOf(n,e))return e;if(W.isCharacterDataNode(n)){var l=W.getNodeIndex(n);if(0==s)s=l;else{if(s!=n.length)throw t.createError("splitNodeAt() should not be called with offset in the middle of a data node ("+s+" in "+n.data);s=l+1}n=n.parentNode}if(b(n,s)){r=n.cloneNode(!1),o=n.parentNode,r.id&&r.removeAttribute("id");for(var p,h=0;p=n.childNodes[s];)d(p,r,h++,i);return d(r,o,W.getNodeIndex(n)+1,i),n==e?r:S(e,o,W.getNodeIndex(r),i)}if(e!=n){r=n.parentNode;var u=W.getNodeIndex(n);return a||u++,S(e,r,u,i)}return e}function A(e,t){return e.tagName==t.tagName&&a(e,t)&&c(e,t)&&"inline"==j(e,"display")&&"inline"==j(t,"display")}function R(e){var t=e?"nextSibling":"previousSibling";return function(n,s){var i=n.parentNode,r=n[t];if(r){if(r&&3==r.nodeType)return r}else if(s&&(r=i[t],r&&1==r.nodeType&&A(i,r)))return r[e?"firstChild":"lastChild"];return null}}function x(e){this.isElementMerge=1==e.nodeType,this.textNodes=[];var t=this.isElementMerge?e.lastChild:e;t&&(this.textNodes[0]=t)}function w(e,t,s){this.cssClass=e;var i,r,o,a,l=null;if("object"==typeof t&&null!==t){for(s=t.tagNames,l=t.elementProperties,r=0;a=H[r++];)t.hasOwnProperty(a)&&(this[a]=t[a]);i=t.normalize}else i=t;this.normalize="undefined"==typeof i?!0:i,this.attrExceptions=[];var d=document.createElement(this.elementTagName);this.elementProperties=this.copyPropertiesToElement(l,d,!0),this.elementSortedClassName=this.elementProperties.hasOwnProperty("className")?this.elementProperties.className:e,this.applyToAnyTagName=!1;var p=typeof s;if("string"==p)"*"==s?this.applyToAnyTagName=!0:this.tagNames=n(s.toLowerCase()).split(/\s*,\s*/);else if("object"==p&&"number"==typeof s.length)for(this.tagNames=[],r=0,o=s.length;o>r;++r)"*"==s[r]?this.applyToAnyTagName=!0:this.tagNames.push(s[r].toLowerCase());else this.tagNames=[this.elementTagName]}function P(e,t,n){return new w(e,t,n)}e.requireModules(["WrappedSelection","WrappedRange"]);var O,W=e.dom,M=W.DomPosition,I="span",L=function(){function e(e,t,n){return t&&n?" ":""}return function(t,n){t.className&&(t.className=t.className.replace(new RegExp("(^|\\s)"+n+"(\\s|$)"),e))}}(),j=W.getComputedStyleProperty;!function(){var e=document.createElement("div");O="boolean"==typeof e.isContentEditable?function(e){return e&&1==e.nodeType&&e.isContentEditable}:function(e){return e&&1==e.nodeType&&"false"!=e.contentEditable?"true"==e.contentEditable||O(e.parentNode):!1}}();var B=/^inline(-block|-table)?$/i,z=/[^\r\n\t\f \u200B]/,D=R(!1),$=R(!0);x.prototype={doMerge:function(e){var t=this.textNodes,n=t[0];if(t.length>1){for(var s,i,r,o,a=[],l=0,d=0,p=t.length;p>d;++d){if(s=t[d],i=s.parentNode,d>0&&(i.removeChild(s),i.hasChildNodes()||i.parentNode.removeChild(i),e))for(r=0;o=e[r++];)o.node==s&&(o.node=n,o.offset+=l);a[d]=s.data,l+=s.data.length}n.data=a.join("")}return n.data},getLength:function(){for(var e=this.textNodes.length,t=0;e--;)t+=this.textNodes[e].length;return t},toString:function(){for(var e=[],t=0,n=this.textNodes.length;n>t;++t)e[t]="'"+this.textNodes[t].data+"'";return"[Merge("+e.join(",")+")]"}};var H=["elementTagName","ignoreWhiteSpace","applyToEditableOnly","useExistingElements","removeEmptyElements"],V={};w.prototype={elementTagName:I,elementProperties:{},ignoreWhiteSpace:!0,applyToEditableOnly:!1,useExistingElements:!0,removeEmptyElements:!0,copyPropertiesToElement:function(e,t,n){var s,o,a,l,d,p,h={};for(var u in e)if(e.hasOwnProperty(u))if(l=e[u],d=t[u],"className"==u)i(t,l),i(t,this.cssClass),t[u]=r(t[u]),n&&(h[u]=t[u]);else if("style"==u){o=d,n&&(h[u]=a={});for(s in e[u])o[s]=l[s],n&&(a[s]=o[s]);this.attrExceptions.push(u)}else t[u]=l,n&&(h[u]=t[u],p=V.hasOwnProperty(u)?V[u]:u,this.attrExceptions.push(p));return n?h:""},hasClass:function(e){return 1==e.nodeType&&W.arrayContains(this.tagNames,e.tagName.toLowerCase())&&s(e,this.cssClass)},getSelfOrAncestorWithClass:function(e){for(;e;){if(this.hasClass(e))return e;e=e.parentNode}return null},isModifiable:function(e){return!this.applyToEditableOnly||v(e)},isIgnorableWhiteSpaceNode:function(e){return this.ignoreWhiteSpace&&e&&3==e.nodeType&&C(e)},postApply:function(e,t,n,s){for(var i,r,o,a=e[0],l=e[e.length-1],d=[],p=a,h=l,u=0,f=l.length,c=0,g=e.length;g>c;++c)r=e[c],o=D(r,!s),o?(i||(i=new x(o),d.push(i)),i.textNodes.push(r),r===a&&(p=i.textNodes[0],u=p.length),r===l&&(h=i.textNodes[0],f=i.getLength())):i=null;var m=$(l,!s);if(m&&(i||(i=new x(l),d.push(i)),i.textNodes.push(m)),d.length){for(c=0,g=d.length;g>c;++c)d[c].doMerge(n);t.setStartAndEnd(p,u,h,f)}},createContainer:function(e){var t=e.createElement(this.elementTagName);return this.copyPropertiesToElement(this.elementProperties,t,!1),i(t,this.cssClass),t},applyToTextNode:function(e){var t=e.parentNode;if(1==t.childNodes.length&&this.useExistingElements&&W.arrayContains(this.tagNames,t.tagName.toLowerCase())&&m(t,this.elementProperties))i(t,this.cssClass);else{var n=this.createContainer(W.getDocument(e));e.parentNode.insertBefore(n,e),n.appendChild(e)}},isRemovable:function(e){return e.tagName.toLowerCase()==this.elementTagName&&o(e)==this.elementSortedClassName&&m(e,this.elementProperties)&&!g(e,this.attrExceptions)&&this.isModifiable(e)},isEmptyContainer:function(e){var t=e.childNodes.length;return 1==e.nodeType&&this.isRemovable(e)&&(0==t||1==t&&this.isEmptyContainer(e.firstChild))},removeEmptyContainers:function(e){for(var t,n=this,s=e.getNodes([1],function(e){return n.isEmptyContainer(e)}),i=0;t=s[i++];)t.parentNode.removeChild(t)},undoToTextNode:function(e,t,n,s){if(!t.containsNode(n)){var i=t.cloneRange();i.selectNode(n),i.isPointInRange(t.endContainer,t.endOffset)&&(S(n,t.endContainer,t.endOffset,s),t.setEndAfter(n)),i.isPointInRange(t.startContainer,t.startOffset)&&(n=S(n,t.startContainer,t.startOffset,s))}this.isRemovable(n)?h(n,s):L(n,this.cssClass)},applyToRange:function(e,t){t=t||[];var n=T(t||[]);e.splitBoundariesPreservingPositions(n),this.removeEmptyElements&&this.removeEmptyContainers(e);var s=f(e);if(s.length){for(var i,r=0;i=s[r++];)this.isIgnorableWhiteSpaceNode(i)||this.getSelfOrAncestorWithClass(i)||!this.isModifiable(i)||this.applyToTextNode(i,n);i=s[s.length-1],e.setStartAndEnd(s[0],0,i,i.length),this.normalize&&this.postApply(s,e,n,!1),E(t,n)}},applyToRanges:function(e){for(var t=e.length;t--;)this.applyToRange(e[t],e);return e},applyToSelection:function(t){var n=e.getSelection(t);n.setRanges(this.applyToRanges(n.getAllRanges()))},undoToRange:function(e,t){t=t||[];var n=T(t);e.splitBoundariesPreservingPositions(n),this.removeEmptyElements&&this.removeEmptyContainers(e,n);var s,i,r=f(e),o=r[r.length-1];if(r.length){for(var a=0,l=r.length;l>a;++a)s=r[a],i=this.getSelfOrAncestorWithClass(s),i&&this.isModifiable(s)&&this.undoToTextNode(s,e,i,n),e.setStartAndEnd(r[0],0,o,o.length);this.normalize&&this.postApply(r,e,n,!0),E(t,n)}},undoToRanges:function(e){for(var t=e.length;t--;)this.undoToRange(e[t],e);return e},undoToSelection:function(t){var n=e.getSelection(t),s=e.getSelection(t).getAllRanges();this.undoToRanges(s),n.setRanges(s)},getTextSelectedByRange:function(e,t){var n=t.cloneRange();n.selectNodeContents(e);var s=n.intersection(t),i=s?s.toString():"";return n.detach(),i},isAppliedToRange:function(e){if(e.collapsed)return!!this.getSelfOrAncestorWithClass(e.commonAncestorContainer);for(var t,n=e.getNodes([3]),s=0;t=n[s++];)if(!this.isIgnorableWhiteSpaceNode(t)&&u(e,t)&&this.isModifiable(t)&&!this.getSelfOrAncestorWithClass(t))return!1;return!0},isAppliedToRanges:function(e){for(var t=e.length;t--;)if(!this.isAppliedToRange(e[t]))return!1;return!0},isAppliedToSelection:function(t){var n=e.getSelection(t);return this.isAppliedToRanges(n.getAllRanges())},toggleRange:function(e){this.isAppliedToRange(e)?this.undoToRange(e):this.applyToRange(e)},toggleRanges:function(e){this.isAppliedToRanges(e)?this.undoToRanges(e):this.applyToRanges(e)},toggleSelection:function(e){this.isAppliedToSelection(e)?this.undoToSelection(e):this.applyToSelection(e)},detach:function(){}},w.util={hasClass:s,addClass:i,removeClass:L,hasSameClasses:a,replaceWithOwnChildren:h,elementsHaveSameNonClassAttributes:c,elementHasNonClassAttributes:g,splitNodeAt:S,isEditableElement:O,isEditingHost:N,isEditable:v},e.CssClassApplier=w,e.createCssClassApplier=P});