
/*!
Mercury Editor is a Coffeescript and jQuery based WYSIWYG editor released under the MIT License.
Documentation and other useful information can be found at https://github.com/jejacks0n/mercury

Copyright (c) 2013 Jeremy Jackson
*/


(function() {

  this.Mercury || (this.Mercury = {});

  Mercury.configuration = {
    logging: {
      enabled: true,
      notifier: 'error'
    },
    localization: {
      enabled: true,
      preferred: 'en-US'
    },
    uploading: {
      enabled: true,
      saveUrl: '/mercury/uploads',
      saveName: 'file',
      mimeTypes: ['image/jpeg', 'image/gif', 'image/png'],
      maxSize: 5242880
    },
    templates: {
      enabled: true,
      prefixUrl: '/mercury/templates'
    },
    regions: {
      attribute: 'data-mercury',
      identifier: 'id',
      image: {
        mimeTypes: ['image/jpeg']
      },
      gallery: {
        mimeTypes: ['image/jpeg']
      }
    }
  };

}).call(this);
(function(){Number.prototype.toHex=function(){var e;return e=this.toString(16).toUpperCase(),e[1]?e:"0"+e},Number.prototype.toBytes=function(){var e,t,n;n=[""," kb"," Mb"," Gb"," Tb"," Pb"," Eb"],e=parseInt(this),t=0;while(1023<e)e/=1024,t+=1;return t?""+e.toFixed(2)+n[t]:""+e+" bytes"}}).call(this),function(){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")},String.prototype.toCamelCase=function(e){return e==null&&(e=!1),e?this.toTitleCase().replace(/([\-|_][a-z])/g,function(e){return e.toUpperCase().replace(/[\-|_]/,"")}):this.replace(/([\-|_][a-z])/g,function(e){return e.toUpperCase().replace(/[\-|_]/,"")})},String.prototype.toDash=function(){return this.replace(/([A-Z])/g,function(e){return"-"+e.toLowerCase()}).replace(/^-+|-+$/g,"")},String.prototype.toUnderscore=function(){return this.replace(/([A-Z])/g,function(e){return"_"+e.toLowerCase()}).replace(/^_+|_+$/g,"")},String.prototype.toTitleCase=function(){return this[0].toUpperCase()+this.slice(1)},String.prototype.toHex=function(){return this[0]==="#"?this.toString():this.replace(/rgb(a)?\(([0-9|%]+)[\s|,]?\s?([0-9|%]+)[\s|,]?\s?([0-9|%]+)[\s|,]?\s?([0-9|.|%]+\s?)?\)/gi,function(e,t,n,r,i,s){return"#"+parseInt(n).toHex()+parseInt(r).toHex()+parseInt(i).toHex()})},String.prototype.regExpEscape=function(){var e,t;return t=["/",".","*","+","?","|","(",")","[","]","{","}","\\"],e=new RegExp("(\\"+t.join("|\\")+")","g"),this.replace(e,"\\$1")},String.prototype.printf=function(){var e,t,n,r,i,s,o,u,a,f;n=this.split("%"),u=n[0],o=/^([sdf])([\s\S%]*)$/,i=0;for(r=a=0,f=n.length;a<f;r=++a){t=n[r],s=o.exec(t);if(r===0||!s||arguments[r]===null){r>1&&(i+=2,u+="%"+t);continue}e=arguments[r-1-i];switch(s[1]){case"s":u+=e;break;case"d":case"i":u+=parseInt(e.toString(),10);break;case"f":u+=parseFloat(e)}u+=s[2]}return u}}.call(this),function(){var e=[].slice;this.Mercury||(this.Mercury={}),Mercury.Config={get:function(e){var t,n,r,i,s;t=this.configuration||(this.configuration=Mercury.configuration||(Mercury.configuration={}));try{if(e){s=e.split(":");for(r=0,i=s.length;r<i;r++)n=s[r],t=t[n]}}catch(o){return}return t},set:function(){var t,n,r,i,s,o;t=1<=arguments.length?e.call(arguments,0):[],o=t.pop(),s=t.shift();if(!s)return this.configuration=o;n=this.configuration||(this.configuration=Mercury.configuration||(Mercury.configuration={})),i=s.split(":"),r=i.shift();while(r){if(i.length===0)return n[r]=o,n[r];n=n[r]?n[r]:n[r]={},r=i.shift()}}},Mercury.Config.Module={config:Mercury.Config.get}}.call(this),function(){var e=[].slice;this.Mercury||(this.Mercury={}),Mercury.Events={on:function(e,t){var n,r,i,s;e=e.split(" "),n=this.__handlers__||(this.__handlers__={});for(i=0,s=e.length;i<s;i++)r=e[i],n[r]||(n[r]=[]),n[r].push(t);return this},one:function(e,t){return this.on(e,function(){return this.off(e,arguments.callee),t.apply(this,arguments)})},off:function(e,t){var n,r,i,s,o,u;if(!e)return this.__handlers__={},this;if(!(i=(u=this.__handlers__)!=null?u[e]:void 0))return this;if(!t)return delete this.__handlers__[e],this;for(r=s=0,o=i.length;s<o;r=++s){n=i[r];if(n!==t)continue;i=i.slice(),i.splice(r,1),this.__handlers__[e]=i;break}return this},trigger:function(){var t,n,r,i,s,o,u;t=1<=arguments.length?e.call(arguments,0):[],n=t.shift(),typeof this.log=="function"&&this.log(n,t);if(!(i=(u=this.__handlers__)!=null?u[n]:void 0))return!1;for(s=0,o=i.length;s<o;s++){r=i[s];if(r.apply(this,t)===!1)break}return!0}}}.call(this),function(){var e=[].slice;this.Mercury||(this.Mercury={}),Mercury.I18n={__locales__:{},define:function(e,t){return this.__locales__[e]=t},locale:function(){var e,t,n,r,i;return this.__determined__?this.__determined__:((n=Mercury.configuration.localization)!=null?!n.enabled:!void 0)?[{},{}]:(i=(this.clientLocale()||((r=Mercury.configuration.localization)!=null?r.preferred:void 0)).split("-"),t=i[0],e=i[1],t=this.__locales__[t],t&&e&&(e=t["_"+e.toUpperCase()+"_"]),this.__determined__=[t||{},e||{}])},t:function(){var t,n,r,i,s,o;return n=arguments[0],t=2<=arguments.length?e.call(arguments,1):[],o=Mercury.I18n.locale(),i=o[0],r=o[1],s=(r[n]||i[n]||n||"").toString(),t.length?s.printf.apply(s,t):s},clientLocale:function(){var e;return(e=navigator.language)!=null?e.toString():void 0}},Mercury.I18n.Module={t:Mercury.I18n.t}}.call(this),function(){var e=[].slice;this.Mercury||(this.Mercury={}),Mercury.Logger={logPrefix:"Mercury:",log:function(){var t,n;t=1<=arguments.length?e.call(arguments,0):[];if((n=Mercury.configuration.logging)!=null?!n.enabled:!void 0)return;return this.logPrefix&&t.unshift(this.logPrefix),typeof console!="undefined"&&console!==null?typeof console.debug=="function"?console.debug.apply(console,t):void 0:void 0},notify:function(e){var t;this.logPrefix&&(e=""+this.logPrefix+" "+e);try{return console.error(e),typeof console.trace=="function"?console.trace():void 0}catch(n){switch((t=Mercury.configuration.logging)!=null?t.notifier:void 0){case"alert":return alert(e);case"error":throw new Error(e)}}}}}.call(this),function(){this.Mercury||(this.Mercury={}),Mercury.Stack={pushStack:function(e){if(e===null)return;return this.stack=this.stack.slice(0,this.stackPosition+1),this.stack.push(e),this.stack.length>this.maxStackLength&&this.stack.shift(),this.stackPosition=this.stack.length-1},undoStack:function(){return this.stackPosition<1?null:(this.stackPosition-=1,this.stack[this.stackPosition])},redoStack:function(){return this.stackPosition>=this.stack.length-1?null:(this.stackPosition+=1,this.stack[this.stackPosition])},included:function(){var e;return e=this.prototype||this,e.stackPosition=0,e.maxStackLength=200,e.stack=[]}}}.call(this),function(){this.Mercury||(this.Mercury={}),Mercury.Module=function(){function t(){typeof this.init=="function"&&this.init.apply(this,arguments)}var e;return e=["included","extended","private"],t.extend=function(t){var n,r,i,s;if(!t)throw new Error("extend expects an object");r=t.Module||t;for(i in r){n=r[i];if(e.indexOf(i)>-1)continue;this[i]=n}return(s=r.extended)!=null?s.apply(this):void 0},t.include=function(t){var n,r,i,s;if(!t)throw new Error("include expects an object");r=t.Module||t;for(i in r){n=r[i];if(e.indexOf(i)>-1)continue;this.prototype[i]=n}return(s=r.included)!=null?s.apply(this):void 0},t.proxy=function(e){var t=this;return function(){return e.apply(t,arguments)}},t.prototype.proxy=function(e){var t=this;return function(){return e.apply(t,arguments)}},t}()}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};this.Mercury||(this.Mercury={}),Mercury.Model=function(e){function n(e){e==null&&(e={}),this.attributes={},this.errors={},this.set(e),this.cid=this.constructor.uid("c"),n.__super__.constructor.apply(this,arguments)}return t(n,e),n.extend(Mercury.Config),n.extend(Mercury.Events),n.include(Mercury.Config),n.include(Mercury.Events),n.include(Mercury.I18n),n.include(Mercury.Logger),n.include(Mercury.Stack),n.prototype.logPrefix="Mercury.Model:",n.idCounter=1,n.define=function(e,t){return this.className=e,this.urlPrefix=t,this.logPrefix=this.prototype.logPrefix=""+this.className+":",this.records={},this.off(),this},n.url=function(e){return this.urlPrefix},n.find=function(e){var t;t=this.records[e];if(!t&&(""+e).match(/^\d+/))return this.find("c"+e);if(!t)throw new Error(""+this.className+" found no records with the ID '"+e+"'");return t},n.all=function(){var e,t,n,r;n=this.records,r=[];for(e in n)t=n[e],r.push(t);return r},n.count=function(){return this.all().length},n.toJSON=function(){return this.all()},n.contains=function(e){try{return this.find(e)}catch(t){return!1}},n.uid=function(e){var t;return e==null&&(e=""),t=e+this.idCounter++,this.contains(t)&&(t=this.uid(e)),t},n.prototype.validate=function(){},n.prototype.save=function(e){var t,n=this;return e==null&&(e={}),this.isValid()?(t={method:this.isNew()?"POST":"PUT",url:this.constructor.url(this),accepts:"application/json",cache:!1,data:this.toJSON(),success:function(e){return n.id=e.id,n.id&&(n.constructor.records[n.id]=n),n.set(e),n.trigger("save"),typeof n.saveSuccess=="function"?n.saveSuccess.apply(n,arguments):void 0},error:function(e){return n.trigger("error"),n.notify(n.t("Unable to process response: %s",e.status)),typeof n.saveError=="function"?n.saveError.apply(n,arguments):void 0}},$.ajax($.extend(t,e))):!1},n.prototype.toJSON=function(){return $.extend(!0,{},this.attributes)},n.prototype.isNew=function(){return!this.exists()},n.prototype.isValid=function(){var e,t,n;this.errors={},this.validate(),n=this.errors;for(e in n)return t=n[e],!1;return!0},n.prototype.addError=function(e,t){var n;return((n=this.errors)[e]||(n[e]=[])).push(t)},n.prototype.errorMessages=function(){var e,t,n,r;if(this.isValid())return!1;t=[],r=this.errors;for(e in r)n=r[e],t.push(""+n.join(", "));return t.join("\n")},n.prototype.get=function(e){return this.attributes[e]},n.prototype.set=function(e,t){var n,r;n={},typeof e=="object"?n=e:n[e]=t,this.pushStack($.extend(!0,{},this.attributes)),r=[];for(e in n)t=n[e],r.push(this.attributes[e]=t);return r},n.prototype.exists=function(){return this.id&&this.id in this.constructor.records},n}(Mercury.Module)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].slice;this.Mercury||(this.Mercury={}),Mercury.View=function(e){function r(e){var t,n,i;this.options=e!=null?e:{},i=this.options;for(t in i)n=i[t],this[t]=n;this.el||(this.el=document.createElement(this.tag)),this.el=$(this.el),this.$el=this.el,this.attr(this.attributes),this.addClass(this.className),this.template&&this.html(this.renderTemplate(this.template)),this.events||(this.events=this.constructor.events),this.elements||(this.elements=this.constructor.elements),typeof this.build=="function"&&this.build(),this.events&&this.delegateEvents(this.events),this.elements&&this.refreshElements(),r.__super__.constructor.apply(this,arguments)}return t(r,e),r.include(Mercury.Config),r.include(Mercury.Events),r.include(Mercury.I18n),r.include(Mercury.Logger),r.prototype.logPrefix="Mercury.View:",r.prototype.eventSplitter=/^(\S+)\s*(.*)$/,r.prototype.tag="div",r.prototype.$=function(e){return $(e,this.el)},r.prototype.addClass=function(e){return this.el.addClass(e)},r.prototype.attr=function(e,t){return e&&arguments.length===1?this.el.attr(e):this.el.attr(e,t)},r.prototype.html=function(e){return arguments.length?(this.el.html((e!=null?e.el:void 0)||e),this.refreshElements(),this.el):this.el.html()},r.prototype.append=function(){var e,t,r;return t=1<=arguments.length?n.call(arguments,0):[],t=function(){var n,r,i;i=[];for(n=0,r=t.length;n<r;n++)e=t[n],i.push(e.el||e);return i}(),(r=this.el).append.apply(r,t),this.refreshElements(),this.el},r.prototype.appendTo=function(e){return this.el.appendTo(e.el||e),this.el},r.prototype.delay=function(e,t){var n=this;return setTimeout(function(){return t.call(n)},e)},r.prototype.refreshElements=function(){var e,t,n,r;n=this.elements,r=[];for(e in n)t=n[e],r.push(this[e]=this.$(t));return r},r.prototype.renderTemplate=function(e,t){var n;return t==null&&(t=null),n=JST["/mercury/templates/"+e],this.config("templates:enabled")&&!n&&(n=this.fetchTemplate(e)),typeof n=="function"?n(t||this):n},r.prototype.fetchTemplate=function(e){var t;return t=null,$.ajax({url:[this.config("templates:prefixUrl"),e].join("/"),async:!1,success:function(e){return t=e}}),t},r.prototype.release=function(){return this.trigger("release"),this.el.remove(),this.off()},r.prototype.delegateEvents=function(e){var t,n,r,i,s,o,u,a=this;u=[];for(n in e){i=e[n];if(typeof i=="function")i=function(e){return function(){return e.apply(a,arguments),!0}}(i);else if(i.indexOf(":")>-1)i=function(e){return function(){return Mercury.trigger(e,a),!0}}(i);else{if(!this[i])throw new Error(""+i+" doesn't exist");i=function(e){return function(){return a[e].apply(a,arguments),!0}}(i)}if(n.indexOf(":")>-1){Mercury.on(n,i);continue}o=n.match(this.eventSplitter),r=o[0],t=o[1],s=o[2],u.push(this.el.on(t,s||null,i))}return u},r}(Mercury.Module)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].slice;this.Mercury||(this.Mercury={}),Mercury.Region=function(e){function r(e,t){this.el=e,this.options=t!=null?t:{};if(!this.constructor.supported)return this.notify(this.t("is unsupported in this browser"));r.__super__.constructor.call(this,this.options),this.attr({tabindex:this.tabIndex||0}),this.name||(this.name=this.el.attr(this.config("regions:identifier"))),this.name||(this.notify(this.t('no name provided for the "%s" region, falling back to random',this.constructor.type)),this.name=""+this.constructor.type+Math.floor(Math.random()*1e4)),this.previewing||(this.previewing=!1),this.bindDefaultEvents()}return t(r,e),r.extend(Mercury.Config),r.extend(Mercury.Events),r.extend(Mercury.I18n),r.extend(Mercury.Logger),r.include(Mercury.Stack),r.supported=!0,r.type="unknown",r.prototype.logPrefix="Mercury.Region:",r.define=function(e,t,n){return this.className=e,this.type=t,this.actions=n,this.logPrefix=this.prototype.logPrefix=""+this.className+":",this.off(),this},r.create=function(e){var t;return e=$(e),t=e.attr(this.config("regions:attribute")),t||this.notify(this.t("region type not provided")),t=(""+t+"_region").toLowerCase().toCamelCase(!0),Mercury[t]||this.notify(this.t('unknown "%s" region type, falling back to base region',t)),new(Mercury[t]||Mercury.Region)(e)},r.prototype.bindDefaultEvents=function(){var e=this;this.delegateEvents({focus:function(){return typeof e.onFocus=="function"?e.onFocus():void 0},blur:function(){return typeof e.onBlur=="function"?e.onBlur():void 0}}),Mercury.on("action",function(){return e.handleAction.apply(e,arguments)}),this.delegateActions($.extend(!0,this.constructor.actions,this.actions||(this.actions={})));if(typeof this.dropFile=="function")return this.delegateDropFile()},r.prototype.handleAction=function(){var e,t,r;return e=1<=arguments.length?n.call(arguments,0):[],typeof (t=this.actions)[r=e.shift()]=="function"?t[r].apply(t,e):void 0},r.prototype.data=function(e,t){return t?this.el.data(e,t):this.el.data(e)},r.prototype.snippets=function(){return{}},r.prototype.toJSON=function(){return{name:this.name,type:this.constructor.type,value:this.html(),data:this.data(),snippets:this.snippets()}},r.prototype.release=function(){return this.trigger("release"),this.off()},r.prototype.delegateDropFile=function(){var e=this;return this.el.on("dragenter",function(e){return e.preventDefault()}),this.el.on("dragover",function(e){return e.preventDefault()}),this.el.on("drop",function(t){if(!t.originalEvent.dataTransfer.files.length)return;return t.preventDefault(),e.dropFile(t.originalEvent.dataTransfer.files)})},r.prototype.delegateActions=function(e){var t,n,r,i=this;r=[];for(t in e){n=e[t];if(typeof n=="function")n=function(e){return function(){return e.apply(i,arguments),!0}}(n);else{if(!this[n])throw new Error(""+n+" doesn't exist");n=function(e){return function(){return i[e].apply(i,arguments),!0}}(n)}r.push(this.actions[t]=n)}return r},r}(Mercury.View)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.GalleryRegion=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.supported=!0,n.define("Mercury.GalleryRegion","gallery",{undo:"undo",redo:"redo"}),n.prototype.className="mercury-gallery-region",n.prototype.elements={controls:".mercury-gallery-region-controls",slides:".slides",paginator:".paginator"},n.prototype.events={"click .mercury-gallery-region-controls em":"removeSlide","click .mercury-gallery-region-controls img":"gotoSlide"},n.prototype.build=function(){var e=this;return this.speed||(this.speed=3e3),this.append('<ul class="mercury-gallery-region-controls"></ul>'),this.index=1,this.refresh(!0),this.delay(this.speed,function(){return e.nextSlide()}),this.pushStack(this.el.html())},n.prototype.onBlur=function(){return this.controls.hide()},n.prototype.onFocus=function(){return this.controls.show()},n.prototype.undo=function(){var e;return(e=this.undoStack())&&this.html(e),this.refresh(!0)},n.prototype.redo=function(){var e;return(e=this.redoStack())&&this.html(e),this.refresh(!0)},n.prototype.refresh=function(e){e==null&&(e=!1),this.images=this.$(".slide").hide(),this.index>this.images.length&&(this.index=1),this.$(".slide:nth-child("+this.index+")").show(),this.paginator.html(Array(this.images.length+1).join("<span>&bull;</span>")),this.paginator.find("span:nth-child("+this.index+")").addClass("active");if(e)return this.refreshControls()},n.prototype.refreshControls=function(){var e,t,n,r,i;this.controls.html(""),r=this.images,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(this.addLink($(e)));return i},n.prototype.nextSlide=function(){var e=this;return this.index+=1,this.refresh(),this.timeout=this.delay(this.speed,function(){return e.nextSlide()})},n.prototype.gotoSlide=function(e){var t=this;return clearTimeout(this.timeout),this.index=$(e.target).closest("li").prevAll("li").length+1,this.refresh(),this.timeout=this.delay(this.speed,function(){return t.nextSlide()})},n.prototype.addLink=function(e){var t;return t=e.find("img").attr("src"),this.controls.append($('<li><img src="'+t+'"/><em>&times;</em></li>').data({slide:e}))},n.prototype.dropFile=function(e){var t,n=this;return t=new Mercury.Uploader(e,{mimeTypes:this.config("regions:gallery:mimeTypes")}),t.on("uploaded",function(){return n.appendSlide.apply(n,arguments)})},n.prototype.appendSlide=function(e){var t;if(!e.isImage())return;return t=$('<div class="slide"><img src="'+e.get("url")+'"/></div>'),this.slides.append(t),this.addLink(t),this.refresh(),this.pushStack(this.el.html())},n.prototype.removeSlide=function(e){var t,n,r,i=this;return t=$(e.target).closest("li"),r=t.data("slide"),n=r.prevAll(".slide").length+1,r.remove(),t.remove(),n<this.index?this.index-=1:n===this.index&&(clearTimeout(this.timeout),this.timeout=this.delay(this.speed,function(){return i.nextSlide()})),this.refresh(),this.pushStack(this.el.html())},n}(Mercury.Region)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.Editor=function(e){function n(e){var t;this.options=e!=null?e:{},n.__super__.constructor.apply(this,arguments),this.regions=function(){var e,n,r,i;r=this.regionElements(),i=[];for(e=0,n=r.length;e<n;e++)t=r[e],i.push(Mercury.Region.create(t));return i}.call(this)}return t(n,e),n.prototype.logPrefix="Mercury.Editor:",n.prototype.attributes={id:"mercury"},n.prototype.regionElements=function(){return $("["+this.config("regions:attribute")+"]")},n.prototype.save=function(){var e,t,n,r,i;e={},i=this.regions;for(n=0,r=i.length;n<r;n++)t=i[n],e[t.name]=t.toJSON();return e},n}(Mercury.View)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.File=function(e){function n(e,t){this.file=e,this.options=t!=null?t:{},n.__super__.constructor.call(this,{name:this.file.name,type:this.file.type,size:this.file.size,url:null})}return t(n,e),n.define("Mercury.File"),n.url=function(){return this.config("uploading:saveUrl")},n.prototype.validate=function(){var e;if(this.get("size")>=this.config("uploading:maxSize")){this.addError("size",this.t("Too large"));return}e=this.options.mimeTypes||this.config("uploading:mimeTypes");if(e&&e.indexOf(this.get("type"))<=-1)return this.addError("type",this.t("Unsupported format (%s)",this.get("type")))},n.prototype.readAsDataURL=function(e){var t;if(!window.FileReader)return;return t=new FileReader,t.onload=function(){if(e)return e(t.result)},t.readAsDataURL(this.file)},n.prototype.readableSize=function(){return this.get("size").toBytes()},n.prototype.isImage=function(){return["image/jpeg","image/gif","image/png"].indexOf(this.get("type"))>-1},n.prototype.save=function(e){var t;return e==null&&(e={}),t={data:this.toFormData(),processData:!1,contentType:!1,xhr:function(){var t,n,r,i,s;r=$.ajaxSettings.xhr(),s=e.uploadEvents||{},i=function(e,t){return r.upload["on"+e]=t};for(t in s)n=s[t],i(t,n);return r}},n.__super__.save.call(this,$.extend(t,e))},n.prototype.toFormData=function(){var e;if(!window.FormData)return;return e=new FormData,e.append(this.config("uploading:saveName"),this.file,this.get("name")),e},n.prototype.saveSuccess=function(){if(!this.get("url"))return this.notify(this.t("Malformed response from server (%s)","no url"))},n}(Mercury.Model)}.call(this),function(){this.JST||(this.JST={}),JST["/mercury/templates/uploader"]=function(e){return'<div class="mercury-uploader-dialog">\n  <div class="mercury-uploader-preview"><b><img/></b></div>\n  <div class="mercury-uploader-details"></div>\n  <div class="mercury-uploader-progress">\n    <span></span>\n    <div class="mercury-uploader-indicator"><div><b>0%</b></div></div>\n  </div>\n</div>'}}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.Uploader=function(e){function n(e,t){this.options=t!=null?t:{};if(!this.constructor.supported)return this.notify(this.t("is unsupported in this browser"));n.__super__.constructor.call(this,this.options),this.loaded=0,this.total=0,this.files=[];if(!this.calculate(e||[]).length)return;this.show(),this.delay(500,this.upload)}return t(n,e),n.supported=!!window.FormData&&!!(new XMLHttpRequest).upload,n.prototype.logPrefix="Mercury.Uploader:",n.prototype.template="uploader",n.prototype.className="mercury-uploader",n.prototype.attributes={style:"opacity:0"},n.prototype.elements={status:".mercury-uploader-progress span",details:".mercury-uploader-details",preview:".mercury-uploader-preview b",indicator:".mercury-uploader-indicator div",percent:".mercury-uploader-indicator b"},n.prototype.calculate=function(e){var t,n,r;for(n=0,r=e.length;n<r;n++){t=e[n],t=new Mercury.File(t,{mimeTypes:this.mimeTypes});if(!t.isValid()){alert(this.t("Error uploading %s: %s",t.get("name"),t.errorMessages()));continue}this.files.push(t),this.total+=t.get("size")}return this.files},n.prototype.build=function(){return this.appendTo($("#mercury"))},n.prototype.show=function(){var e=this;return this.update(this.t("Processing...")),this.delay(1,function(){return e.el.css({opacity:1})})},n.prototype.release=function(e){return e==null&&(e=0),this.delay(e,function(){return this.el.css({opacity:0}),this.delay(250,function(){return n.__super__.release.apply(this,arguments)})})},n.prototype.upload=function(){var e,t=this;if(!this.files.length)return this.release(500);this.file=this.files.shift(),this.update(this.t("Uploading...")),this.loadDetails();if(e=this.file.save({uploadEvents:this.uploadEvents()}))return e.success(function(){return t.success()}),e.error(function(){return t.error()})},n.prototype.update=function(e,t){var n;return t==null&&(t=0),e&&this.status.html(e),n=Math.floor((this.loaded+t)*100/this.total)+"%",this.indicator.css({width:n}),this.percent.html(n)},n.prototype.loadDetails=function(){var e=this;this.details.html([this.t("Name: %s",this.file.get("name")),this.t("Type: %s",this.file.get("type")),this.t("Size: %s",this.file.readableSize())].join("<br/>"));if(!this.file.isImage())return;return this.file.readAsDataURL(function(t){return e.preview.html($("<img>",{src:t}))})},n.prototype.success=function(){return this.trigger("uploaded",this.file),this.loaded+=this.file.get("size"),this.update(this.t("Successfully uploaded...")),this.upload()},n.prototype.error=function(){return this.update(this.t("Error: Unable to upload the file")),this.delay(3e3,this.upload)},n.prototype.uploadEvents=function(){var e=this;return{progress:function(t){return e.update(e.t("Uploading..."),t.loaded),e.percent.show()}}},n}(Mercury.View)}.call(this),function(){var e;e=function(){return this.version="1.0.0",this.Module.extend.call(this,this.Config),this.configure=this.Config.set,this.Module.extend.call(this,this.Events),this.Module.extend.call(this,this.I18n),this.Module.extend.call(this,this.Logger)},e.call(Mercury)}.call(this);