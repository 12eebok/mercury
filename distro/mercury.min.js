
/*!
Mercury Editor is a Coffeescript and jQuery based WYSIWYG editor released under the MIT License.
Documentation and other useful information can be found at https://github.com/jejacks0n/mercury

Copyright (c) 2013 Jeremy Jackson
*/


(function() {

  this.Mercury || (this.Mercury = {});

  Mercury.configuration = {
    logging: {
      enabled: true,
      notifier: 'console'
    },
    localization: {
      enabled: true,
      preferred: 'en-US'
    },
    uploading: {
      enabled: true,
      saveUrl: '/mercury/uploads',
      saveName: 'file',
      mimeTypes: ['image/jpeg', 'image/gif', 'image/png'],
      maxSize: 5242880
    },
    templates: {
      enabled: true,
      prefixUrl: '/mercury/templates'
    },
    regions: {
      attribute: 'data-mercury',
      identifier: 'id',
      image: {
        mimeTypes: ['image/jpeg']
      },
      gallery: {
        mimeTypes: ['image/jpeg']
      },
      markdown: {
        autoSize: true,
        mimeTypes: false
      }
    }
  };

}).call(this);
(function(){Number.prototype.toHex=function(){var e;return e=this.toString(16).toUpperCase(),e[1]?e:"0"+e},Number.prototype.toBytes=function(){var e,t,n;n=[""," kb"," Mb"," Gb"," Tb"," Pb"," Eb"],e=parseInt(this),t=0;while(1023<e)e/=1024,t+=1;return t?""+e.toFixed(2)+n[t]:""+e+" bytes"}}).call(this),function(){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")},String.prototype.toCamelCase=function(e){return e==null&&(e=!1),e?this.toTitleCase().replace(/([\-|_][a-z])/g,function(e){return e.toUpperCase().replace(/[\-|_]/,"")}):this.replace(/([\-|_][a-z])/g,function(e){return e.toUpperCase().replace(/[\-|_]/,"")})},String.prototype.toDash=function(){return this.replace(/([A-Z])/g,function(e){return"-"+e.toLowerCase()}).replace(/^-+|-+$/g,"")},String.prototype.toUnderscore=function(){return this.replace(/([A-Z])/g,function(e){return"_"+e.toLowerCase()}).replace(/^_+|_+$/g,"")},String.prototype.toTitleCase=function(){return this[0].toUpperCase()+this.slice(1)},String.prototype.toHex=function(){return this[0]==="#"?this.toString():this.replace(/rgb(a)?\(([0-9|%]+)[\s|,]?\s?([0-9|%]+)[\s|,]?\s?([0-9|%]+)[\s|,]?\s?([0-9|.|%]+\s?)?\)/gi,function(e,t,n,r,i,s){return"#"+parseInt(n).toHex()+parseInt(r).toHex()+parseInt(i).toHex()})},String.prototype.regExpEscape=function(){var e,t;return t=["/",".","*","+","?","|","(",")","[","]","{","}","\\"],e=new RegExp("(\\"+t.join("|\\")+")","g"),this.replace(e,"\\$1")},String.prototype.printf=function(){var e,t,n,r,i,s,o,u,a,f;n=this.split("%"),u=n[0],o=/^([sdf])([\s\S%]*)$/,i=0;for(r=a=0,f=n.length;a<f;r=++a){t=n[r],s=o.exec(t);if(r===0||!s||arguments[r]===null){r>1&&(i+=2,u+="%"+t);continue}e=arguments[r-1-i];switch(s[1]){case"s":u+=e;break;case"d":case"i":u+=parseInt(e.toString(),10);break;case"f":u+=parseFloat(e)}u+=s[2]}return u}}.call(this),function(){var e=[].slice;this.Mercury||(this.Mercury={}),Mercury.Config={get:function(e){var t,n,r,i,s;t=Mercury.configuration||(Mercury.configuration={});try{if(e){s=e.split(":");for(r=0,i=s.length;r<i;r++)n=s[r],t=t[n]}}catch(o){return}return t},set:function(){var t,n,r,i,s,o;t=1<=arguments.length?e.call(arguments,0):[],o=t.pop(),s=t.shift();if(!s)return Mercury.configuration=o;n=Mercury.configuration||(Mercury.configuration={}),i=s.split(":"),r=i.shift();while(r){if(i.length===0)return n[r]=o,n[r];n=n[r]?n[r]:n[r]={},r=i.shift()}}},Mercury.Config.Module={config:Mercury.Config.get}}.call(this),function(){var e=[].slice;this.Mercury||(this.Mercury={}),Mercury.Events={on:function(e,t){var n,r,i,s;e=e.split(" "),n=this.__handlers__||(this.__handlers__={});for(i=0,s=e.length;i<s;i++)r=e[i],n[r]||(n[r]=[]),n[r].push(t);return this},one:function(e,t){return this.on(e,function(){return this.off(e,arguments.callee),t.apply(this,arguments)})},off:function(e,t){var n,r,i,s,o,u;if(!e)return this.__handlers__={},this;if(!(i=(u=this.__handlers__)!=null?u[e]:void 0))return this;if(!t)return delete this.__handlers__[e],this;for(r=s=0,o=i.length;s<o;r=++s){n=i[r];if(n!==t)continue;i=i.slice(),i.splice(r,1),this.__handlers__[e]=i;break}return this},trigger:function(){var t,n,r,i,s,o,u;t=1<=arguments.length?e.call(arguments,0):[],n=t.shift(),typeof this.log=="function"&&this.log(n,t);if(!(i=(u=this.__handlers__)!=null?u[n]:void 0))return!1;for(s=0,o=i.length;s<o;s++){r=i[s];if(r.apply(this,t)===!1)break}return!0}}}.call(this),function(){var e=[].slice;this.Mercury||(this.Mercury={}),Mercury.I18n={__locales__:{},define:function(e,t){return this.__locales__[e]=t},locale:function(){var e,t,n,r,i;return this.__determined__?this.__determined__:((n=Mercury.configuration.localization)!=null?!n.enabled:!void 0)?[{},{}]:(i=(this.clientLocale()||((r=Mercury.configuration.localization)!=null?r.preferred:void 0)).split("-"),t=i[0],e=i[1],t=this.__locales__[t],t&&e&&(e=t["_"+e.toUpperCase()+"_"]),this.__determined__=[t||{},e||{}])},t:function(){var t,n,r,i,s,o;return n=arguments[0],t=2<=arguments.length?e.call(arguments,1):[],o=Mercury.I18n.locale(),i=o[0],r=o[1],s=(r[n]||i[n]||n||"").toString(),t.length?s.printf.apply(s,t):s},clientLocale:function(){var e;return(e=navigator.language)!=null?e.toString():void 0}},Mercury.I18n.Module={t:Mercury.I18n.t}}.call(this),function(){var e=[].slice;this.Mercury||(this.Mercury={}),Mercury.Logger={logPrefix:"Mercury:",log:function(){var t,n;t=1<=arguments.length?e.call(arguments,0):[];if((n=Mercury.configuration.logging)!=null?!n.enabled:!void 0)return;return this.logPrefix&&t.unshift(this.logPrefix),typeof console!="undefined"&&console!==null?typeof console.debug=="function"?console.debug.apply(console,t):void 0:void 0},notify:function(e){var t,n;this.logPrefix&&(e=""+this.logPrefix+" "+e);if(((t=Mercury.configuration.logging)!=null?t.notifier:void 0)==="console")try{return console.error(e)}catch(r){}else if(((n=Mercury.configuration.logging)!=null?n.notifier:void 0)==="alert")return alert(e);throw new Error(e)}}}.call(this),function(){this.Mercury||(this.Mercury={}),Mercury.Stack={included:function(){return this.stackPosition=0,this.maxStackLength=200,this.stack=[]},pushStack:function(e){if(e===null||JSON.stringify(this.stack[this.stackPosition])===JSON.stringify(e))return;return this.stack=this.stack.slice(0,this.stackPosition+1),this.stack.push(e),this.stack.length>this.maxStackLength&&this.stack.shift(),this.stackPosition=this.stack.length-1},undoStack:function(){return this.stackPosition<1?null:(this.stackPosition-=1,this.stack[this.stackPosition])},redoStack:function(){return this.stackPosition>=this.stack.length-1?null:(this.stackPosition+=1,this.stack[this.stackPosition])}}}.call(this),function(){this.Mercury||(this.Mercury={}),Mercury.Module=function(){function t(){typeof this.init=="function"&&this.init.apply(this,arguments)}var e;return e=["included","extended","private"],t.extend=function(t){var n,r,i,s;if(!t)throw new Error("extend expects an object");r=t.Module||t;for(i in r){n=r[i];if(e.indexOf(i)>-1)continue;this[i]=n}return(s=r.extended)!=null?s.apply(this):void 0},t.include=function(t){var n,r,i,s;if(!t)throw new Error("include expects an object");r=t.Module||t;for(i in r){n=r[i];if(e.indexOf(i)>-1)continue;this.prototype[i]=n}return(s=r.included)!=null?s.apply(this.prototype):void 0},t.proxy=function(e){var t=this;return function(){return e.apply(t,arguments)}},t.prototype.proxy=function(e){var t=this;return function(){return e.apply(t,arguments)}},t}()}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};this.Mercury||(this.Mercury={}),Mercury.Model=function(e){function n(e){e==null&&(e={}),this.attributes={},this.errors={},this.set(e),this.cid=this.constructor.uid("c"),n.__super__.constructor.apply(this,arguments)}return t(n,e),n.extend(Mercury.Config),n.extend(Mercury.Events),n.include(Mercury.Config),n.include(Mercury.Events),n.include(Mercury.I18n),n.include(Mercury.Logger),n.include(Mercury.Stack),n.prototype.logPrefix="Mercury.Model:",n.idCounter=1,n.define=function(e,t){return this.className=e,this.urlPrefix=t,this.logPrefix=this.prototype.logPrefix=""+this.className+":",this.records={},this.off(),this},n.url=function(e){return this.urlPrefix},n.find=function(e){var t;t=this.records[e];if(!t&&(""+e).match(/^\d+/))return this.find("c"+e);if(!t)throw new Error(""+this.className+" found no records with the ID '"+e+"'");return t},n.all=function(){var e,t,n,r;n=this.records,r=[];for(e in n)t=n[e],r.push(t);return r},n.count=function(){return this.all().length},n.toJSON=function(){return this.all()},n.contains=function(e){try{return this.find(e)}catch(t){return!1}},n.uid=function(e){var t;return e==null&&(e=""),t=e+this.idCounter++,this.contains(t)&&(t=this.uid(e)),t},n.prototype.validate=function(){},n.prototype.save=function(e){var t,n=this;return e==null&&(e={}),this.isValid()?(t={method:this.isNew()?"POST":"PUT",url:this.constructor.url(this),accepts:"application/json",cache:!1,data:this.toJSON(),success:function(e){return n.id=e.id,n.id&&(n.constructor.records[n.id]=n),n.set(e),n.trigger("save"),typeof n.saveSuccess=="function"?n.saveSuccess.apply(n,arguments):void 0},error:function(e){return n.trigger("error"),n.notify(n.t("Unable to process response: %s",e.status)),typeof n.saveError=="function"?n.saveError.apply(n,arguments):void 0}},$.ajax($.extend(t,e))):!1},n.prototype.toJSON=function(){return $.extend(!0,{},this.attributes)},n.prototype.isNew=function(){return!this.exists()},n.prototype.isValid=function(){var e,t,n;this.errors={},this.validate(),n=this.errors;for(e in n)return t=n[e],!1;return!0},n.prototype.addError=function(e,t){var n;return((n=this.errors)[e]||(n[e]=[])).push(t)},n.prototype.errorMessages=function(){var e,t,n,r;if(this.isValid())return!1;t=[],r=this.errors;for(e in r)n=r[e],t.push(""+n.join(", "));return t.join("\n")},n.prototype.get=function(e){return this.attributes[e]},n.prototype.set=function(e,t){var n,r;n={},typeof e=="object"?n=e:n[e]=t,this.pushStack($.extend(!0,{},this.attributes)),r=[];for(e in n)t=n[e],r.push(this.attributes[e]=t);return r},n.prototype.exists=function(){return this.id&&this.id in this.constructor.records},n}(Mercury.Module)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].slice;this.Mercury||(this.Mercury={}),Mercury.View=function(e){function r(e){var t,n,i;this.options=e!=null?e:{},i=this.options;for(t in i)n=i[t],this[t]=n;this.el||(this.el=document.createElement(this.tag)),this.el=$(this.el),this.$el=this.el,this.attr(this.attributes),this.addClass(this.className),this.template&&this.html(this.renderTemplate(this.template)),this.elements||(this.elements=this.constructor.elements),this.events||(this.events=this.constructor.events),typeof this.build=="function"&&this.build(),this.events&&this.delegateEvents(this.events),this.elements&&this.refreshElements(),r.__super__.constructor.apply(this,arguments)}return t(r,e),r.include(Mercury.Config),r.include(Mercury.Events),r.include(Mercury.I18n),r.include(Mercury.Logger),r.prototype.logPrefix="Mercury.View:",r.prototype.eventSplitter=/^(\S+)\s*(.*)$/,r.prototype.tag="div",r.prototype.$=function(e){return $(e,this.el)},r.prototype.addClass=function(e){return this.el.addClass(e)},r.prototype.attr=function(e,t){return e&&arguments.length===1?this.el.attr(e):this.el.attr(e,t)},r.prototype.html=function(e){return arguments.length?(this.el.html((e!=null?e.el:void 0)||e),this.refreshElements(),this.el):this.el.html()},r.prototype.append=function(){var e,t,r;return t=1<=arguments.length?n.call(arguments,0):[],t=function(){var n,r,i;i=[];for(n=0,r=t.length;n<r;n++)e=t[n],i.push(e.el||e);return i}(),(r=this.el).append.apply(r,t),this.refreshElements(),this.el},r.prototype.appendTo=function(e){return this.el.appendTo(e.el||e),this.el},r.prototype.delay=function(e,t){var n=this;return setTimeout(function(){return t.call(n)},e)},r.prototype.refreshElements=function(){var e,t,n,r;n=this.elements,r=[];for(e in n)t=n[e],r.push(this[e]=this.$(t));return r},r.prototype.renderTemplate=function(e,t){var n;return t==null&&(t=null),n=JST["/mercury/templates/"+e],this.config("templates:enabled")&&!n&&(n=this.fetchTemplate(e)),typeof n=="function"?n(t||this):n},r.prototype.fetchTemplate=function(e){var t;return t=null,$.ajax({url:[this.config("templates:prefixUrl"),e].join("/"),async:!1,success:function(e){return t=e}}),t},r.prototype.release=function(){return this.trigger("release"),this.el.remove(),this.off()},r.prototype.delegateEvents=function(e,t){var n,r,i,s,o,u,a,f=this;arguments.length===1&&(t=e,e=this.el),a=[];for(r in t){s=t[r];if(typeof s=="function")s=function(e){return function(){return e.apply(f,arguments),!0}}(s);else if(s.indexOf(":")>-1)s=function(e){return function(){return Mercury.trigger(e,f),!0}}(s);else{if(!this[s])throw new Error(""+s+" doesn't exist");s=function(e){return function(){return f[e].apply(f,arguments),!0}}(s)}if(r.indexOf(":")>-1){Mercury.on(r,s);continue}u=r.match(this.eventSplitter),i=u[0],n=u[1],o=u[2],a.push(e.on(n,o||null,s))}return a},r}(Mercury.Module)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].slice;this.Mercury||(this.Mercury={}),Mercury.Region=function(e){function r(e,t){this.el=e,this.options=t!=null?t:{};if(!this.constructor.supported)return this.notify(this.t("is unsupported in this browser"));typeof this.beforeBuild=="function"&&this.beforeBuild(),r.__super__.constructor.call(this,this.options),this.focusable||this.attr({tabindex:0}),this.name||(this.name=this.el.attr(this.config("regions:identifier"))),this.name||(this.notify(this.t('no name provided for the "%s" region, falling back to random',this.constructor.type)),this.name=""+this.constructor.type+Math.floor(Math.random()*1e4)),this.previewing||(this.previewing=!1),this.focused||(this.focused=!1),this.focusable||(this.focusable=this.el),this.skipHistoryOn||(this.skipHistoryOn=["redo"]),this.addClass("mercury-"+this.constructor.type+"-region"),this.trigger("build"),typeof this.afterBuild=="function"&&this.afterBuild(),this.pushHistory(),this.bindDefaultEvents()}return t(r,e),r.extend(Mercury.Config),r.extend(Mercury.Events),r.extend(Mercury.I18n),r.extend(Mercury.Logger),r.include(Mercury.Stack),r.Modules={},r.supported=!0,r.logPrefix="Mercury.Region:",r.type="unknown",r.defaultActions={undo:"onUndo",redo:"onRedo"},r.define=function(e,t,n){return this.className=e,this.type=t,n==null&&(n={}),this.logPrefix=this.prototype.logPrefix=""+this.className+":",this.prototype.actions=$.extend(this.prototype.actions,n),this.off(),this},r.create=function(e){var t;return e=$(e),t=e.attr(this.config("regions:attribute")),t||this.notify(this.t("region type not provided")),t=(""+t+"_region").toLowerCase().toCamelCase(!0),Mercury[t]||this.notify(this.t('unknown "%s" region type, falling back to base region',t)),new(Mercury[t]||Mercury.Region)(e)},r.prototype.handleAction=function(){var e,t;t=1<=arguments.length?n.call(arguments,0):[];if(!this.focused||this.previewing)return;return e=t.shift(),this.skipHistoryOn.indexOf(e)>-1||this.pushHistory(),this.actions[e]&&this.actions[e].apply(this,t),this.trigger("action",e),!0},r.prototype.handleMode=function(){var e,t,r;return e=1<=arguments.length?n.call(arguments,0):[],t=e.shift(),typeof this[r=("toggle_"+t).toCamelCase()]=="function"?this[r].apply(this,e):void 0},r.prototype.togglePreview=function(){return this.previewing=!this.previewing,this.trigger("preview",this.previewing),this.previewing?(this.blur(),this.focusable.removeAttr("tabindex")):this.focusable.attr({tabindex:0}),typeof this.onTogglePreview=="function"?this.onTogglePreview():void 0},r.prototype.pushHistory=function(){var e;return this.pushStack((e=typeof this.valueForStack==="function"?this.valueForStack():void 0)!=null?e:this.value())},r.prototype.focus=function(){return this.focused=!0,this.focusable.focus(),typeof this.onFocus=="function"?this.onFocus():void 0},r.prototype.blur=function(){return this.focused=!1,this.focusable.blur(),typeof this.onBlur=="function"?this.onBlur():void 0},r.prototype.value=function(e){return e==null&&(e=null),e===null||typeof e=="undefined"?this.html():this.html(e)},r.prototype.data=function(e,t){return t?this.el.data(e,t):this.el.data(e)},r.prototype.snippets=function(){return{}},r.prototype.onUndo=function(){return this.value(this.undoStack())},r.prototype.onRedo=function(){return this.value(this.redoStack())},r.prototype.toJSON=function(){return{name:this.name,type:this.constructor.type,value:this.value(),data:this.data(),snippets:this.snippets()}},r.prototype.release=function(){return this.el.removeClass("mercury-"+this.constructor.type+"-region"),this.focusable.removeAttr("tabindex"),this.trigger("release"),this.el.off(),this.focusable.off(),this.off(),this.blur()},r.prototype.bindDefaultEvents=function(){var e=this;Mercury.on("action",function(){return e.handleAction.apply(e,arguments)}),Mercury.on("mode",function(){return e.handleMode.apply(e,arguments)}),this.delegateActions($.extend(!0,this.constructor.actions,this.constructor.defaultActions,this.actions||(this.actions={}))),this.bindFocusEvents(),this.bindKeyEvents();if(typeof this.onDropFile=="function")return this.bindDropEvents()},r.prototype.bindFocusEvents=function(){var e=this;return this.delegateEvents(this.focusable,{focus:function(){return e.focused=!0,e.trigger("focus"),typeof e.onFocus=="function"?e.onFocus():void 0},blur:function(){return e.focused=!1,e.trigger("blur"),typeof e.onBlur=="function"?e.onBlur():void 0}})},r.prototype.bindKeyEvents=function(){var e=this;return this.delegateEvents(this.focusable,{keydown:function(t){if(!t.metaKey||t.keyCode!==90)return;return t.preventDefault(),t.shiftKey?e.handleAction("redo"):e.handleAction("undo")}})},r.prototype.bindDropEvents=function(){var e,t=this;return e=function(e){return e.preventDefault()},this.delegateEvents(this.focusable,{dragenter:e,dragover:this.editableDragOver&&Mercury.support.webkit?function(){}:e,drop:function(e){if(!e.originalEvent.dataTransfer.files.length)return;return e.preventDefault(),t.onDropFile(e.originalEvent.dataTransfer.files)}})},r.prototype.delegateActions=function(e){var t,n,r;r=[];for(t in e){n=e[t];if(typeof n!="function"){if(!this[n])throw new Error(""+n+" doesn't exist");n=this[n]}r.push(this.actions[t]=n)}return r},r}(Mercury.View)}.call(this),function(){this.JST||(this.JST={}),JST["/mercury/templates/editor"]=function(e){return'<ul id="mercury_controls">\n  <li data-action="preview">Toggle Preview</li>\n  <li data-action="undo">Undo</li>\n  <li data-action="redo">Redo</li>\n  <hr/>\n  <li data-action="direction">custom action (toggle rtl/ltr)</li>\n  <hr/>\n  <li data-action="block" data-value="none">none</li>\n  <li data-action="block" data-value="h1">h1</li>\n  <li data-action="block" data-value="h2">h2</li>\n  <li data-action="block" data-value="h3">h3</li>\n  <li data-action="block" data-value="h4">h4</li>\n  <li data-action="block" data-value="h5">h5</li>\n  <li data-action="block" data-value="h6">h6</li>\n  <li data-action="block" data-value="pre">pre</li>\n  <li data-action="block" data-value="paragraph">paragraph</li>\n  <li data-action="block" data-value="blockquote">blockquote</li>\n  <hr/>\n  <li data-action="bold">bold</li>\n  <li data-action="italic">italic</li>\n  <li data-action="underline">underline</li>\n  <li data-action="subscript">subscript</li>\n  <li data-action="superscript">superscript</li>\n  <hr/>\n  <li data-action="orderedList">orderedList</li>\n  <li data-action="unorderedList">unorderedList</li>\n  <hr/>\n  <li data-action="indent">indent</li>\n  <li data-action="outdent">outdent</li>\n  <hr/>\n  <li data-action="style" data-value="border:1px solid red">style</li>\n  <li data-action="style" data-value="foo">class</li>\n  <hr/>\n  <li data-action="html" data-value="html">html (with html)</li>\n  <li data-action="html" data-value="el">html (with element)</li>\n  <li data-action="html" data-value="jquery">html (with jQuery)</li>\n  <hr/>\n  <li data-action="link" data-value="https://github.com/jejacks0n/mercury">link</li>\n  <li data-action="image" data-value="http://goo.gl/UWYSd">image</li>\n  <hr/>\n  <li data-action="rule">rule</li>\n  <hr/>\n  <li><input type="text"/></li>\n</ul>'}}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.Editor=function(e){function n(e){var t,r,i,s,o;this.options=e!=null?e:{},n.__super__.constructor.apply(this,arguments),this.regions||(this.regions=[]),s=this.regionElements();for(r=0,i=s.length;r<i;r++)t=s[r],this.addRegion(t);(o=this.regions[0])!=null&&o.focus()}return t(n,e),n.prototype.logPrefix="Mercury.Editor:",n.prototype.template="editor",n.prototype.attributes={id:"mercury"},n.prototype.events={mousedown:"keepRegionFocused","click [data-action]":"processAction"},n.prototype.regionElements=function(){return $("["+this.config("regions:attribute")+"]")},n.prototype.addRegion=function(e){var t,n=this;return t=Mercury.Region.create(e),t.on("focus",function(){return n.region=t}),this.regions.push(t)},n.prototype.keepRegionFocused=function(e){return e.preventDefault(),this.region.focus()},n.prototype.save=function(){var e,t,n,r,i;e={},i=this.regions;for(n=0,r=i.length;n<r;n++)t=i[n],e[t.name]=t.toJSON();return e},n.prototype.processAction=function(e){var t,n,r;n=$(e.target),t=n.data("action"),r=n.data("value");switch(t){case"preview":return Mercury.trigger("mode","preview");case"html":return r=function(){switch(r){case"html":return"<table>\n  <tr>\n    <td>1</td>\n    <td>2</td>\n  </tr>\n</table>";case"el":return $('<section class="foo"><h1>testing</h1></section>').get(0);case"jquery":return $('<section class="foo"><h1>testing</h1></section>')}}(),Mercury.trigger("action",t,r);default:return Mercury.trigger("action",t,r)}},n}(Mercury.View)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.File=function(e){function n(e,t){this.file=e,this.options=t!=null?t:{},n.__super__.constructor.call(this,{name:this.file.name,type:this.file.type,size:this.file.size,url:null})}return t(n,e),n.define("Mercury.File"),n.url=function(){return this.config("uploading:saveUrl")},n.prototype.validate=function(){var e,t;if(this.get("size")>=this.config("uploading:maxSize")){this.addError("size",this.t("Too large"));return}e=(t=this.options["mimeTypes"])!=null?t:this.config("uploading:mimeTypes");if(e&&e.indexOf(this.get("type"))<=-1)return this.addError("type",this.t("Unsupported format (%s)",this.get("type")))},n.prototype.readAsDataURL=function(e){var t;if(!window.FileReader)return;return t=new FileReader,t.onload=function(){if(e)return e(t.result)},t.readAsDataURL(this.file)},n.prototype.readableSize=function(){return this.get("size").toBytes()},n.prototype.isImage=function(){return["image/jpeg","image/gif","image/png"].indexOf(this.get("type"))>-1},n.prototype.save=function(e){var t;return e==null&&(e={}),t={data:this.toFormData(),processData:!1,contentType:!1,xhr:function(){var t,n,r,i,s;r=$.ajaxSettings.xhr(),s=e.uploadEvents||{},i=function(e,t){return r.upload["on"+e]=t};for(t in s)n=s[t],i(t,n);return r}},n.__super__.save.call(this,$.extend(t,e))},n.prototype.toFormData=function(){var e;if(!window.FormData)return;return e=new FormData,e.append(this.config("uploading:saveName"),this.file,this.get("name")),e},n.prototype.saveSuccess=function(){if(!this.get("url"))return this.notify(this.t("Malformed response from server (%s)","no url"))},n}(Mercury.Model)}.call(this),function(){this.JST||(this.JST={}),JST["/mercury/templates/uploader"]=function(e){return'<div class="mercury-uploader-dialog">\n  <div class="mercury-uploader-preview"><b><img/></b></div>\n  <div class="mercury-uploader-details"></div>\n  <div class="mercury-uploader-progress">\n    <span></span>\n    <div class="mercury-uploader-indicator"><div><b>0%</b></div></div>\n  </div>\n</div>'}}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.Uploader=function(e){function n(e,t){this.options=t!=null?t:{};if(!this.constructor.supported)return this.notify(this.t("is unsupported in this browser"));n.__super__.constructor.call(this,this.options),this.loaded=0,this.total=0,this.files=[];if(!this.calculate(e||[]).length)return;this.show(),this.delay(500,this.upload)}return t(n,e),n.supported=!!window.FormData&&!!(new XMLHttpRequest).upload,n.prototype.logPrefix="Mercury.Uploader:",n.prototype.template="uploader",n.prototype.className="mercury-uploader",n.prototype.attributes={style:"opacity:0"},n.prototype.elements={status:".mercury-uploader-progress span",details:".mercury-uploader-details",preview:".mercury-uploader-preview b",indicator:".mercury-uploader-indicator div",percent:".mercury-uploader-indicator b"},n.prototype.calculate=function(e){var t,n,r;for(n=0,r=e.length;n<r;n++){t=e[n],t=new Mercury.File(t,{mimeTypes:this.mimeTypes});if(!t.isValid()){alert(this.t("Error uploading %s: %s",t.get("name"),t.errorMessages()));continue}this.files.push(t),this.total+=t.get("size")}return this.files},n.prototype.build=function(){return this.appendTo($("#mercury"))},n.prototype.show=function(){var e=this;return this.update(this.t("Processing...")),this.delay(1,function(){return e.el.css({opacity:1})})},n.prototype.release=function(e){return e==null&&(e=0),this.delay(e,function(){return this.el.css({opacity:0}),this.delay(250,function(){return n.__super__.release.apply(this,arguments)})})},n.prototype.upload=function(){var e,t=this;if(!this.files.length)return this.release(500);this.file=this.files.shift(),this.update(this.t("Uploading...")),this.loadDetails();if(e=this.file.save({uploadEvents:this.uploadEvents()}))return e.success(function(){return t.success()}),e.error(function(){return t.error()})},n.prototype.update=function(e,t){var n;return t==null&&(t=0),e&&this.status.html(e),n=Math.floor((this.loaded+t)*100/this.total)+"%",this.indicator.css({width:n}),this.percent.html(n)},n.prototype.loadDetails=function(){var e=this;this.details.html([this.t("Name: %s",this.file.get("name")),this.t("Type: %s",this.file.get("type")),this.t("Size: %s",this.file.readableSize())].join("<br/>"));if(!this.file.isImage())return;return this.file.readAsDataURL(function(t){return e.preview.html($("<img>",{src:t}))})},n.prototype.success=function(){return this.trigger("uploaded",this.file),this.loaded+=this.file.get("size"),this.update(this.t("Successfully uploaded...")),this.upload()},n.prototype.error=function(){return this.update(this.t("Error: Unable to upload the file")),this.delay(3e3,this.upload)},n.prototype.uploadEvents=function(){var e=this;return{progress:function(t){return e.update(e.t("Uploading..."),t.loaded),e.percent.show()}}},n}(Mercury.View)}.call(this),function(){Mercury.Region.Modules.DropIndicator={included:function(){return this.dropIndicator=$('<div class="mercury-region-drop-indicator"></div>'),this.on("build",this.buildDropIndicator),this.on("release",this.releaseDropIndicator)},buildDropIndicator:function(){return this.el.after(this.dropIndicator),this.delegateEvents(this.focusable,{dragenter:"showDropIndicator",dragleave:"hideDropIndicator",drop:"hideDropIndicator"})},releaseDropIndicator:function(){return this.dropIndicator.remove()},dropIndicatorPosition:function(){var e;return e=this.el.position(),{top:e.top+this.el.outerHeight()/2,left:e.left+this.el.outerWidth()/2,display:"block"}},showDropIndicator:function(){var e=this;return clearTimeout(this.dropIndicatorTimer),this.dropIndicator.css(this.dropIndicatorPosition()),this.delay(1,function(){return e.dropIndicator.css({opacity:1})})},hideDropIndicator:function(){var e=this;return this.dropIndicator.css({opacity:0}),this.dropIndicatorTimer=this.delay(500,function(){return e.dropIndicator.hide()})}}}.call(this),function(){var e=[].slice;Mercury.Region.Modules.TextSelection={getSelection:function(){var e,t,n,r;return e=this.focusable.get(0),r=e.value,n=e.selectionStart,t=e.selectionEnd,{start:n,end:t,length:t-n,text:r.slice(n,t)}},setSelection:function(e,t,n){var r,i,s,o;t==null&&(t=0),n==null&&(n=null),s=e.start+t,i=e.end+(n!=null?n:t);if(i<s||typeof i=="undefined")i=s;return r=this.focusable.get(0),o=r.value,s<0&&(s+=o.length),i<0&&(i+=o.length),r.selectionStart=s,r.selectionEnd=i},replaceSelection:function(e){var t,n,r,i;return e==null&&(e=""),n=this.focusable.get(0),i=n.value,r=this.getSelection(),n.value=[i.slice(0,r.start),e,i.slice(r.end)].join(""),t=r.start+e.length,this.setSelection({start:t,end:t})},replaceSelectedLine:function(e,t){return t==null&&(t=""),this.setSelection(e),this.replaceSelection("")},setAndReplaceSelection:function(e,t,n,r,i){return t==null&&(t=""),this.setSelection(e),this.replaceSelection(t),this.setSelection(n,r,i)},replaceSelectionWithParagraph:function(e){var t,n,r,i;return e==null&&(e=""),i=this.value(),n=this.getSelection(),t="\n",i[n.start-1]!=="\n"&&(t+="\n"),n.start||(t=""),r="\n",i[n.end]!=="\n"&&i[n.end+1]!=="\n"&&(r+="\n"),n.end||(r="\n\n"),this.replaceSelection([t,e,r].join(""))},wrapSelected:function(e,t){var n,r,i,s;return t==null&&(t={}),s=this.getTokenAndSelection(e),n=s[0],r=s[1],i=[n.pre,r.text||t.text||"",n.suf].join(""),this.setAndReplaceSelection(r,i,r,0,i.length-r.length)},unwrapSelected:function(e){var t,n,r,i;return i=this.getTokenAndSelection(e),t=i[0],n=i[1],r=n.text.match(t.regexp),!r||r.length!==2?!1:this.setAndReplaceSelection(n,n.text.replace(t.regexp,""),n,0,-r.join("").length)},toggleWrapSelected:function(e,t){t==null&&(t={});if(!this.unwrapSelected(e))return this.wrapSelected(e,t)},wrapSelectedWords:function(e){var t,n,r,i;return i=this.getTokenAndSelection(e),n=i[0],r=i[1],t=this.expandSelectionToWords(r),this.setAndReplaceSelection(t,[n.pre,t.text,n.suf].join(""),r,n.pre.length)},unwrapSelectedWords:function(e){var t,n,r,i;return i=this.getTokenAndSelection(e),n=i[0],r=i[1],t=this.expandSelectionToTokens(r,n),t.cleaned?this.setAndReplaceSelection(t,t.token,r,-t.match[0].length):!1},toggleWrapSelectedWords:function(e){if(!this.unwrapSelectedWords(e))return this.wrapSelectedWords(e)},wrapSelectedLines:function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p;p=this.getTokenAndSelection(e),i=p[0],a=p[1],r=this.expandSelectionToLines(a),u=0,f=0,l=[],o=r.start,t=r.text.split("\n");for(c=0,h=t.length;c<h;c++)s=t[c],s.trim()||t.length===1?(u||(u=i.pre.length),f+=i.pre.length,o+=s.length,o<a.end&&(f+=i.suf.length),l.push([i.pre,s,i.suf].join(""))):(n=!0,o+=s.length,l.push(s));return n&&(u=0),this.setAndReplaceSelection(r,l.join("\n"),a,u,f)},unwrapSelectedLines:function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d;d=this.getTokenAndSelection(e),r=d[0],a=d[1],n=this.expandSelectionToLines(a),o=0,l=0,c=[],s=n.start,t=n.text.split("\n"),u=!0;for(h=0,p=t.length;h<p;h++)i=t[h],f=i.match(r.regexp),f&&f.length===2?(s<=a.start&&(o+=f[0].length),s<a.end&&(l+=f[0].length),s+=i.length,s<=a.start&&(o+=f[1].length),s<a.end&&(l+=f[1].length),c.push(i.replace(r.regexp,""))):(u=!1,s+=i.length,c.push(i));return u||(o=0),this.setAndReplaceSelection(n,c.join("\n"),a,-o,-l),u},wrapSelectedParagraphs:function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d;t==null&&(t={}),d=this.getTokenAndSelection(e),s=d[0],f=d[1],i=this.expandSelectionToParagraphs(f),a=0,l=0,c=[],u=i.start;if(t.all)a=l+=s.pre.length,c.push([s.pre,i.text,s.suf].join(""));else{n=i.text.split("\n");for(h=0,p=n.length;h<p;h++)o=n[h],o.trim()||n.length===1?(u<=f.start&&(a+=s.pre.length),u<f.end&&(l+=s.pre.length),u+=o.length,u<=f.start&&(a+=s.suf.length),u<f.end&&(l+=s.suf.length),c.push([s.pre,o,s.suf].join(""))):(r=!0,u+=o.length,c.push(o));r&&(a=0)}return this.setAndReplaceSelection(i,c.join("\n"),f,a,l)},unwrapSelectedParagraphs:function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v;t==null&&(t={}),d=this.getTokenAndSelection(e),r=d[0],a=d[1],n=this.expandSelectionToParagraphs(a),o=0,l=0,c=[],s=n.start,u=!0;if(t.all)f=n.text.match(r.regexp),f&&f.length===2?(o+=f[0].length,l+=f[1].length,c.push(n.text.replace(r.regexp,""))):c.push(n.text);else{v=n.text.split("\n");for(h=0,p=v.length;h<p;h++)i=v[h],f=i.match(r.regexp),f&&f.length===2?(s<=a.start&&(o+=f[0].length),s<a.end&&(l+=f[0].length),s+=i.length,s<=a.start&&(o+=f[1].length),s<a.end&&(l+=f[1].length),c.push(i.replace(r.regexp,""))):(u=!1,s+=i.length,c.push(i));u||(o=0)}return this.setAndReplaceSelection(n,c.join("\n"),a,-o,-l),u},expandSelectionToWords:function(e){var t,n,r,i,s;s=this.value();if(this.selectionIsEmptyLine(e,s)||this.selectionIsEndOfLine(e,s))return e;r=this.getSelectionStartOfLine(e,s),n=this.getSelectionEndOfLine(e,s),i=s.lastIndexOf(" ",e.start-1),i<r&&(i=r),i>0&&(s[i]===" "||s[i]==="\n")&&(i+=1),t=s.indexOf(" ",e.end);if(t>=n||t===-1)t=n;return{start:i,end:t,text:s.substring(i,t),length:t-i}},expandSelectionToLines:function(e){var t,n,r;return r=this.value(),this.selectionIsEmptyLine(e,r)?e:(n=this.getSelectionStartOfLine(e,r),t=this.getSelectionEndOfLine(e,r),{start:n,end:t,text:r.substring(n,t),length:t-n})},expandSelectionToParagraphs:function(e){var t,n,r;return r=this.value(),this.selectionIsEmptyLine(e,r)?e:(n=r.lastIndexOf("\n\n",e.start-1),n<0&&(n=0),n>0&&(n+=2),n===0&&r[0]==="\n"&&
(n+=1),n===1&&r[1]==="\n"&&(n+=1),n>e.start-1&&(n=e.start),t=r.indexOf("\n\n",e.end-1),e.length&&r.substr(e.end-2,2)==="\n\n"&&(t=e.end),t<0&&(t=r.length),{start:n,end:t,text:r.substring(n,t),length:t-n})},expandSelectionToTokens:function(e,t){var n,r,i,s,o,u,a,f,l;f=this.value();if(this.selectionIsEmptyLine(e,f))return e;if(n=this.selectionIsToken(e,f,t))return n;s=this.getSelectionStartOfLine(e,f),i=this.getSelectionEndOfLine(e,f),u=f.lastIndexOf(t.pre,e.start-1),u<s&&(u=s),u>0&&(f[u]===" "||f[u]==="\n")&&(u+=1),r=f.indexOf(t.suf,e.end-1),r>-1&&(r+=t.suf.length);if(r>i||r===-1)r=i;return a=null,l=f.substring(u,r),o=l.match(t.regexp),o&&o.length===2&&(a=l.replace(t.regexp,"")),{start:u,end:r,text:l,length:r-u,cleaned:a!==null,token:a,match:o}},selectionIsToken:function(e,t,n){var r,i,s,o,u;return e.length>0?!1:(s=e.start-n.pre.length,r=e.end+n.suf.length,o=null,u=t.substring(s,r),i=u.match(n.regexp),i&&i.length===2&&(o=u.replace(n.regexp,"")),o===null?!1:{start:s,end:r,text:u,length:r-s,cleaned:!0,token:o,match:i})},getSelectionStartOfLine:function(e,t){var n;return n=e.start,t[n]!=="\n"&&(n=t.lastIndexOf("\n",n)),n===e.start&&(n=t.lastIndexOf("\n",n-1)),n<0&&(n=0),n===0&&t[0]==="\n"&&e.start===0?n=0:t[n]==="\n"&&(n+=1),n},getSelectionEndOfLine:function(e,t){var n;n=e.end;if(e.length===0||t[n]!=="\n"&&t[n-1]!=="\n")n=t.indexOf("\n",n);return n<0&&(n=t.length),n},selectionIsEmptyLine:function(e,t){return e.length<=1&&t.substr(e.start-1,2)==="\n\n"||e.start===0&&t[0]==="\n"},selectionIsEndOfLine:function(e,t){return t[e.start-1]===" "&&(t[e.start]==="\n"||e.start===t.length)},processWrapper:function(){var t,n,r,i,s;return r=arguments[0],t=2<=arguments.length?e.call(arguments,1):[],n=this.tokenFromWrapper(r),n.pre=(i=n.pre).printf.apply(i,t[0]),n.suf=(s=n.suf).printf.apply(s,t[1]||t[0]),[n.pre,n.suf]},tokenFromWrapper:function(e){var t,n;return typeof e=="string"&&(e=this.wrappers[e]),t=e[0],n=e[1],n==null&&(n=t),{pre:t,suf:n,regexp:e[2]||new RegExp("^"+t.regExpEscape()+"|"+n.regExpEscape()+"$","gi")}},getTokenAndSelection:function(e){return[this.tokenFromWrapper(e),this.getSelection()]}}}.call(this),function(){Mercury.Region.Modules.FocusableTextarea={included:function(){return this.autoSize=!1,this.preview=$('<div class="mercury-'+this.constructor.type+'-region-preview">'),this.focusable=$('<textarea class="mercury-'+this.constructor.type+'-region-textarea">'),this.on("build",this.buildFocusable),this.on("action",this.resizeFocusable),this.on("preview",this.toggleFocusablePreview),this.on("release",this.releaseFocusable)},buildFocusable:function(){var e,t;return this.autoSize=this.config("regions:"+this.constructor.type+":autoSize"),t=this.html().replace("&gt;",">").replace("&lt;","<").trim(),e=this.autoSize?"none":"vertical",this.el.empty(),this.append(this.preview,this.focusable.val(t).css({width:"100%",height:this.el.height(),resize:e})),this.resizeFocusable(),this.delegateEvents({"keydown textarea":"handleKeyEvent"})},releaseFocusable:function(){var e;return this.html((e=typeof this.convertedValue==="function"?this.convertedValue():void 0)!=null?e:this.value())},resizeFocusable:function(){var e,t,n;if(!this.autoSize)return;return n=this.focusable.get(0),e=$("body"),t=e.scrollTop(),this.focusable.css({height:1}).css({height:n.scrollHeight}),$("body").scrollTop(t)},toggleFocusablePreview:function(){return this.previewing?(this.focusable.hide(),this.preview.html((typeof this.convertedValue=="function"?this.convertedValue():void 0)||this.value()).show()):(this.preview.hide(),this.focusable.show())},handleKeyEvent:function(e){if(e.keyCode>=37&&e.keyCode<=40)return;this.delay(1,this.resizeFocusable);if(e.metaKey&&e.keyCode===90)return;e.keyCode===13&&typeof this.onReturnKey=="function"&&this.onReturnKey(e);if(e.metaKey)switch(e.keyCode){case 66:return e.preventDefault(),this.handleAction("bold");case 73:return e.preventDefault(),this.handleAction("italic");case 85:return e.preventDefault(),this.handleAction("underline")}return this.resizeFocusable(),this.pushHistory(e.keyCode)}}}.call(this),function(){var e;e=function(){return this.version="1.0.0",this.Module.extend.call(this,this.Config),this.configure=this.Config.set,this.Module.extend.call(this,this.Events),this.Module.extend.call(this,this.I18n),this.Module.extend.call(this,this.Logger),this.support={webkit:navigator.userAgent.indexOf("WebKit")>0,firefox:navigator.userAgent.indexOf("Firefox")>0}},e.call(Mercury)}.call(this);